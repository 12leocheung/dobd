<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Strike: Campaign Mode</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; user-select: none; touch-action: none; cursor: crosshair; }
        
        /* UI LAYOUT */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* TOP ROW */
        .top-row { display: flex; justify-content: space-between; padding: 15px; align-items: flex-start; }
        
        /* QUEST HUD (New) */
        #quest-panel {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #0f0;
            padding: 10px;
            width: 250px;
            border-radius: 0 0 15px 0;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.1);
            pointer-events: none;
        }
        .quest-header { color: #0f0; font-size: 12px; letter-spacing: 2px; margin-bottom: 5px; border-bottom: 1px solid #0f0; padding-bottom: 2px; }
        .quest-title { color: #fff; font-size: 14px; margin-bottom: 5px; font-weight: bold; }
        .quest-desc { color: #aaa; font-size: 11px; margin-bottom: 8px; }
        .progress-track { width: 100%; height: 6px; background: #111; border: 1px solid #555; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #0f0; transition: width 0.3s ease-out; box-shadow: 0 0 10px #0f0; }

        /* MINIMAP */
        #minimap-container { position: relative; width: 120px; height: 120px; border: 2px solid #0ff; background: rgba(0,0,0,0.8); border-radius: 50%; overflow: hidden; }
        #minimap { width: 100%; height: 100%; }

        /* STATS (Bottom Left) */
        #stats-panel { position: absolute; top: 180px; left: 15px; }
        .stat-row { color: #fff; text-shadow: 0 0 5px #0ff; font-size: 14px; margin-bottom: 4px; }
        #hearts { display: flex; gap: 5px; margin-top: 5px; }
        .heart { width: 18px; height: 18px; background: #f0f; clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'); }
        .heart.lost { opacity: 0.2; }

        /* TRANSMISSION (Center Story) */
        #transmission-panel {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 600px; text-align: center;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        .trans-box { background: rgba(0,0,0,0.9); border: 1px solid #0ff; padding: 20px; color: #0ff; box-shadow: 0 0 20px rgba(0,255,255,0.2); }
        .trans-sender { font-size: 10px; letter-spacing: 3px; color: #fff; margin-bottom: 10px; border-bottom: 1px solid #333; display: inline-block; }
        .trans-text { font-size: 16px; line-height: 1.5; text-shadow: 0 0 5px #0ff; }

        /* CONTROLS & SHOP */
        #powerup-container { position: absolute; bottom: 200px; left: 20px; display: flex; flex-direction: column; gap: 5px; }
        .powerup-tag { background: rgba(0,0,0,0.7); border: 1px solid #fff; color: #fff; padding: 4px 8px; font-size: 12px; border-radius: 4px; }

        #dash-btn { position: absolute; bottom: 140px; right: 30px; width: 70px; height: 70px; border-radius: 50%; border: 2px solid #f0f; background: rgba(255,0,255,0.2); color: #f0f; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: auto; }
        #shop-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 30px; border: 2px solid #0ff; background: #000; color: #0ff; font-family: 'Orbitron'; cursor: pointer; pointer-events: auto; border-radius: 5px; }
        
        #shop-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 500px; }
        .shop-item { border: 1px solid #0ff; padding: 15px; color: #fff; text-align: center; cursor: pointer; transition: 0.2s; background: #111; }
        .shop-item:hover { background: #002222; }
        .shop-item.locked { opacity: 0.5; border-color: #555; color: #555; pointer-events: none; }

        .enemy-hp { position: absolute; width: 40px; height: 4px; background: #300; border: 1px solid #555; transform: translate(-50%, -50%); pointer-events: none; }
        .enemy-hp-bar { height: 100%; background: #f00; width: 100%; transition: width 0.1s; }

        /* Mobile Joysticks */
        .joystick-zone { position: absolute; bottom: 40px; width: 100px; height: 100px; border: 2px solid rgba(0,255,255,0.2); border-radius: 50%; pointer-events: auto; }
        #stick-l { left: 20px; } #stick-r { right: 20px; }
        .knob { width: 40px; height: 40px; background: #0ff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 10px #0ff; }
        
        .mobile-only { display: none; }
        @media (pointer: coarse) { .mobile-only { display: block; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="ui-layer">
        <div class="top-row">
            <div id="quest-panel">
                <div class="quest-header">CURRENT OBJECTIVE</div>
                <div class="quest-title" id="q-title">PHASE 1: CALIBRATION</div>
                <div class="quest-desc" id="q-desc">Kill 3 Drones to calibrate sensors.</div>
                <div class="progress-track">
                    <div class="progress-fill" id="q-bar"></div>
                </div>
            </div>

            <div id="minimap-container">
                <canvas id="minimap"></canvas>
            </div>
        </div>

        <div id="stats-panel">
            <div class="stat-row" id="cash-ui">CASH: $500</div>
            <div class="stat-row" id="wpn-ui">WEAPON: PISTOL</div>
            <div class="stat-row" id="armor-ui">ARMOR: 0</div>
            <div id="hearts">
                <div class="heart" id="h1"></div><div class="heart" id="h2"></div><div class="heart" id="h3"></div>
            </div>
        </div>

        <div id="transmission-panel">
            <div class="trans-box">
                <div class="trans-sender">INCOMING TRANSMISSION // COMMAND</div>
                <div class="trans-text" id="trans-text">System Online.</div>
            </div>
        </div>
        
        <div id="powerup-container"></div>
        <button id="shop-btn" onclick="toggleShop()">OPEN SHOP (Q)</button>
        <div id="dash-btn" class="mobile-only">DASH</div>
        <div id="stick-l" class="joystick-zone mobile-only"><div class="knob" id="knob-l"></div></div>
        <div id="stick-r" class="joystick-zone mobile-only"><div class="knob" id="knob-r"></div></div>
    </div>

    <div id="shop-overlay">
        <h2 style="color:#0ff; margin-bottom:20px;">BLACK MARKET</h2>
        <div id="shop-grid">
            <div class="shop-item" onclick="purchase('PISTOL')">UPGRADE PISTOL ($200)</div>
            <div class="shop-item" onclick="purchase('SHOTGUN')">BUY SHOTGUN ($500)</div>
            <div class="shop-item" onclick="purchase('SMG')">BUY SMG ($1200)</div>
            <div class="shop-item" onclick="purchase('RAILGUN')">BUY RAILGUN ($2500)</div>
            <div class="shop-item" onclick="purchase('FLAMETHROWER')">BUY FLAMETHROWER ($1800)</div>
            <div class="shop-item" onclick="purchase('SPEED')">SERVO UPGRADE ($300)</div>
            <div class="shop-item" onclick="toggleShop()" style="background:#300; border-color:#f00;">CLOSE</div>
        </div>
    </div>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';

// --- CAMPAIGN CONFIGURATION ---
const CAMPAIGN = [
    {
        id: 0,
        title: "PHASE 1: CALIBRATION",
        desc: "Eliminate Hostiles",
        type: 'KILL',
        target: 3,
        startMsg: "Operative, Sector 7 is overrun. Test your targeting systems on the initial wave.",
        endMsg: "Systems calibrated. Readings indicate supply caches nearby."
    },
    {
        id: 1,
        title: "PHASE 2: RESUPPLY",
        desc: "Loot Supply Chests",
        type: 'LOOT',
        target: 2,
        startMsg: "You'll need resources for the battles ahead. Locate and open 2 Supply Chests.",
        endMsg: "Resources acquired. Warning: Heavy signal detected."
    },
    {
        id: 2,
        title: "PHASE 3: THE SWARM",
        desc: "Purge the Area",
        type: 'KILL',
        target: 10,
        startMsg: "The Glitch is reacting to your presence. A swarm is converging. Survive.",
        endMsg: "Swarm neutralized. The constructs are adapting."
    },
    {
        id: 3,
        title: "PHASE 4: UPGRADE",
        desc: "Purchase a Weapon",
        type: 'BUY',
        target: 1,
        startMsg: "Your pistol won't cut it. Access the Black Market (Press Q or Shop Button) and buy a new weapon.",
        endMsg: "Firepower authorized. Let's make some noise."
    },
    {
        id: 4,
        title: "PHASE 5: TOTAL WAR",
        desc: "Eliminate Hostiles",
        type: 'KILL',
        target: 25,
        startMsg: "Command has authorized full lethal force. Clear the sector completely.",
        endMsg: "Sector Clear. Infinite Survival Mode Initiated."
    },
    {
        id: 5,
        title: "SURVIVAL: INFINITE",
        desc: "Survive as long as possible",
        type: 'KILL',
        target: 9999,
        startMsg: "You are on your own now, Operative. Good luck.",
        endMsg: ""
    }
];

// --- GAME STATE ---
let missionIdx = 0;
let missionProgress = 0;
let cash = 500, lives = 3, armor = 0;
let isPaused = false, isFiring = false;
let pSpeed = 0.18, currentWpn = 'PISTOL';
let shakeIntensity = 0;
let dashCooldown = 0, dashActive = 0, invuln = 0;

const bullets = [], enemies = [], buildings = [], chests = [], drops = [], keys = {};
const moveInput = new THREE.Vector2(), aimInput = new THREE.Vector2();
const activePowerups = {};
const muzzleFlashes = [];
const particles = [];
let lastFire = 0;

// WEAPONS DATA
const weapons = {
    PISTOL: { level: 1, owned: true, fireRate: 350, dmg: 1.5, color: 0xffff00, shake: 0.4, spread: 0.05 },
    SHOTGUN: { level: 0, owned: false, fireRate: 800, dmg: 1.2, color: 0xffaa00, shake: 1.8, spread: 0.35 },
    SMG: { level: 0, owned: false, fireRate: 100, dmg: 0.5, color: 0x00ffff, shake: 0.2, spread: 0.15 },
    RAILGUN: { level: 0, owned: false, fireRate: 1500, dmg: 25, color: 0xffffff, shake: 4.5, spread: 0 },
    FLAMETHROWER: { level: 0, owned: false, fireRate: 50, dmg: 0.3, color: 0xff4400, shake: 0.1, spread: 0.25 }
};

// --- THREE.JS SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x020205);
scene.fog = new THREE.FogExp2(0x020205, 0.015);
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ReinhardToneMapping;
document.body.appendChild(renderer.domElement);

// Post Processing
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.5, 0.3));

// Player
const player = new THREE.Group();
const pGeo = new THREE.BoxGeometry(0.8, 1.8, 0.8);
const pMat = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5 });
const pMesh = new THREE.Mesh(pGeo, pMat);
pMesh.position.y = 0.9;
player.add(pMesh);
scene.add(player);

// World
const grid = new THREE.GridHelper(200, 60, 0x004444, 0x001111);
scene.add(grid);
scene.add(new THREE.AmbientLight(0xffffff, 0.2));
const sun = new THREE.DirectionalLight(0xffffff, 0.8);
sun.position.set(10, 20, 10);
scene.add(sun);

// --- MISSION SYSTEM ---
function initMission() {
    const m = CAMPAIGN[missionIdx];
    missionProgress = 0;
    
    // UI Update
    document.getElementById('q-title').innerText = m.title;
    document.getElementById('q-desc').innerText = m.desc + ` (0/${m.target})`;
    document.getElementById('q-bar').style.width = '0%';
    
    // Transmission
    if(m.startMsg) showTransmission(m.startMsg);
}

function updateMission(type, amount) {
    const m = CAMPAIGN[missionIdx];
    if(m.type === type) {
        missionProgress += amount;
        
        // Clamp
        if(missionProgress > m.target) missionProgress = m.target;
        
        // UI
        const pct = (missionProgress / m.target) * 100;
        document.getElementById('q-bar').style.width = pct + '%';
        document.getElementById('q-desc').innerText = m.desc + ` (${missionProgress}/${m.target})`;
        
        // Check Complete
        if(missionProgress >= m.target && missionIdx < CAMPAIGN.length - 1) {
            if(m.endMsg) showTransmission(m.endMsg);
            missionIdx++;
            setTimeout(initMission, 4000); // Delay next mission start so player can read endMsg
        }
    }
}

function showTransmission(text) {
    const panel = document.getElementById('transmission-panel');
    const txt = document.getElementById('trans-text');
    panel.style.opacity = 1;
    txt.innerText = '';
    
    let i = 0;
    const interval = setInterval(() => {
        txt.innerText += text.charAt(i);
        i++;
        if(i >= text.length) {
            clearInterval(interval);
            setTimeout(() => { panel.style.opacity = 0; }, 4000);
        }
    }, 30);
}

// --- GAMEPLAY HELPERS ---
function createBuildings() {
    for(let i=0; i<25; i++) {
        const h = 5 + Math.random() * 15;
        const geo = new THREE.BoxGeometry(5 + Math.random()*5, h, 5 + Math.random()*5);
        const mat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2, metalness: 0.8 });
        const mesh = new THREE.Mesh(geo, mat);
        
        // Random Pos but keep center clear
        let x, z;
        do {
            x = (Math.random()-0.5) * 120;
            z = (Math.random()-0.5) * 120;
        } while(Math.abs(x) < 15 && Math.abs(z) < 15);
        
        mesh.position.set(x, h/2, z);
        
        // Neon Edges
        const edges = new THREE.EdgesGeometry(geo);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff }));
        mesh.add(line);
        
        scene.add(mesh);
        buildings.push({ mesh, box: new THREE.Box3().setFromObject(mesh) });
    }
}

function spawnChest() {
    const geo = new THREE.BoxGeometry(1.5, 1, 1.5);
    const mat = new THREE.MeshStandardMaterial({ color: 0x442200, emissive: 0xffaa00, emissiveIntensity: 0.5 });
    const mesh = new THREE.Mesh(geo, mat);
    
    let x, z, valid = false;
    while(!valid) {
        x = (Math.random()-0.5) * 90;
        z = (Math.random()-0.5) * 90;
        const testPos = new THREE.Vector3(x, 0.5, z);
        valid = !buildings.some(b => b.box.containsPoint(testPos));
    }
    
    mesh.position.set(x, 0.5, z);
    scene.add(mesh);
    chests.push(mesh);
}

function spawnEnemy() {
    const isBig = Math.random() > 0.9;
    const color = isBig ? 0xff0000 : 0xff00ff;
    
    const geo = new THREE.SphereGeometry(isBig ? 1.5 : 0.6);
    const mat = new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.8 });
    const mesh = new THREE.Mesh(geo, mat);
    
    // Spawn away from player
    const angle = Math.random() * Math.PI * 2;
    const dist = 30 + Math.random() * 20;
    mesh.position.set(player.position.x + Math.cos(angle)*dist, isBig ? 1.5 : 0.6, player.position.z + Math.sin(angle)*dist);
    
    // UI Bar
    const ui = document.createElement('div');
    ui.className = 'enemy-hp';
    ui.innerHTML = '<div class="enemy-hp-bar"></div>';
    document.body.appendChild(ui);
    
    scene.add(mesh);
    enemies.push({ 
        mesh, 
        hp: isBig ? 30 : 5, 
        maxHp: isBig ? 30 : 5, 
        ui, 
        isBig,
        radius: isBig ? 1.5 : 0.6 
    });
}

function spawnDrop(pos) {
    const types = ['HEALTH', 'CASH', 'AMMO', 'ARMOR'];
    const type = types[Math.floor(Math.random() * types.length)];
    const color = type === 'HEALTH' ? 0xff0044 : type === 'CASH' ? 0xffff00 : 0x00ff00;
    
    const mesh = new THREE.Mesh(new THREE.OctahedronGeometry(0.4), new THREE.MeshStandardMaterial({ color, emissive: color }));
    mesh.position.copy(pos);
    mesh.position.y = 0.5;
    scene.add(mesh);
    drops.push({ mesh, type });
}

// --- UI & SHOP ---
window.toggleShop = () => {
    isPaused = !isPaused;
    document.getElementById('shop-overlay').style.display = isPaused ? 'flex' : 'none';
};

window.purchase = (item) => {
    let cost = 0;
    let success = false;
    
    if(item === 'PISTOL' && cash >= 200) { cash -= 200; weapons.PISTOL.level++; weapons.PISTOL.dmg *= 1.2; success = true; }
    else if(weapons[item] && !weapons[item].owned && cash >= 2000) { 
        // Logic handled in specific blocks below for correct pricing
    }
    
    // Quick lookups for this demo
    const costs = { SHOTGUN: 500, SMG: 1200, RAILGUN: 2500, FLAMETHROWER: 1800, SPEED: 300 };
    
    if(item === 'SPEED' && cash >= costs.SPEED) {
        cash -= costs.SPEED; pSpeed += 0.05; success = true;
    } else if(weapons[item] && !weapons[item].owned && cash >= costs[item]) {
        cash -= costs[item];
        weapons[item].owned = true;
        currentWpn = item;
        success = true;
        updateMission('BUY', 1); // Trigger mission update
    } else if (item === 'PISTOL' && cash >= 200) {
        // already handled logic above, just ensuring flow
    }

    if(success) updateUI();
};

function updateUI() {
    document.getElementById('cash-ui').innerText = 'CASH: $' + cash;
    document.getElementById('armor-ui').innerText = 'ARMOR: ' + armor;
    document.getElementById('wpn-ui').innerText = 'WEAPON: ' + currentWpn;
    
    for(let i=1; i<=3; i++) {
        const h = document.getElementById('h'+i);
        if(i <= lives) h.classList.remove('lost'); else h.classList.add('lost');
    }
}

// --- MAIN LOOP ---
createBuildings();
for(let i=0; i<6; i++) spawnChest();
initMission(); // Start Campaign
updateUI();

const raycaster = new THREE.Raycaster();
const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);

function animate() {
    requestAnimationFrame(animate);
    if(isPaused) return;

    // 1. Movement
    let spd = dashActive > 0 ? pSpeed * 3 : pSpeed;
    const move = new THREE.Vector3(0, 0, 0);
    if(keys['KeyW']) move.z -= 1;
    if(keys['KeyS']) move.z += 1;
    if(keys['KeyA']) move.x -= 1;
    if(keys['KeyD']) move.x += 1;
    
    // Joystick Override
    if(moveInput.length() > 0.1) { move.x = moveInput.x; move.z = moveInput.y; }
    
    if(move.length() > 0) {
        const nextPos = player.position.clone().add(move.normalize().multiplyScalar(spd));
        let blocked = false;
        buildings.forEach(b => { if(b.box.containsPoint(nextPos)) blocked = true; });
        if(!blocked) player.position.copy(nextPos);
    }
    
    // 2. Aiming
    raycaster.setFromCamera(mouse, camera);
    const target = new THREE.Vector3();
    raycaster.ray.intersectPlane(plane, target);
    
    if(aimInput.length() > 0.1) {
        player.lookAt(player.position.x + aimInput.x, player.position.y, player.position.z + aimInput.y);
    } else {
        player.lookAt(target.x, player.position.y, target.z);
    }

    // 3. Shooting
    if((mouseShooting || isFiring) && Date.now() - lastFire > weapons[currentWpn].fireRate) {
        const w = weapons[currentWpn];
        const num = currentWpn === 'SHOTGUN' ? 5 : 1;
        
        for(let k=0; k<num; k++) {
            const spread = (Math.random()-0.5) * w.spread;
            const dir = new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion);
            dir.applyAxisAngle(new THREE.Vector3(0,1,0), spread);
            
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: w.color }));
            b.position.copy(player.position);
            b.position.y = 0.9;
            scene.add(b);
            bullets.push({ mesh: b, dir: dir, life: 60, speed: currentWpn === 'FLAMETHROWER' ? 0.6 : 1.2 });
        }
        
        shakeIntensity = w.shake;
        lastFire = Date.now();
    }

    // 4. Bullets Logic
    for(let i=bullets.length-1; i>=0; i--) {
        const b = bullets[i];
        b.mesh.position.add(b.dir.clone().multiplyScalar(b.speed));
        b.life--;
        
        let hit = false;
        
        // Wall Hit
        buildings.forEach(wall => {
            if(wall.box.containsPoint(b.mesh.position)) hit = true;
        });
        
        // Enemy Hit
        if(!hit) {
            for(let j=enemies.length-1; j>=0; j--) {
                const e = enemies[j];
                if(b.mesh.position.distanceTo(e.mesh.position) < e.radius + 0.5) {
                    hit = true;
                    e.hp -= weapons[currentWpn].dmg;
                    
                    // Create particle
                    const p = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2), new THREE.MeshBasicMaterial({color: weapons[currentWpn].color}));
                    p.position.copy(b.mesh.position);
                    scene.add(p);
                    particles.push({mesh:p, life:15, vel: new THREE.Vector3((Math.random()-0.5)*0.5, Math.random()*0.5, (Math.random()-0.5)*0.5)});

                    if(e.hp <= 0) {
                        // Enemy Death
                        scene.remove(e.mesh);
                        e.ui.remove();
                        enemies.splice(j, 1);
                        cash += e.isBig ? 150 : 50;
                        updateMission('KILL', 1); // << UPDATE MISSION
                        if(Math.random() > 0.7) spawnDrop(e.mesh.position);
                    }
                    break;
                }
            }
        }
        
        if(hit || b.life <= 0) {
            scene.remove(b.mesh);
            bullets.splice(i, 1);
        }
    }

    // 5. Enemy Logic
    enemies.forEach(e => {
        const dir = new THREE.Vector3().subVectors(player.position, e.mesh.position).normalize();
        const next = e.mesh.position.clone().add(dir.multiplyScalar(e.isBig ? 0.05 : 0.08));
        
        let blocked = false;
        buildings.forEach(b => { if(b.box.containsPoint(next)) blocked = true; });
        if(!blocked) e.mesh.position.copy(next);
        
        // UI Position
        const vector = e.mesh.position.clone();
        vector.project(camera);
        const x = (vector.x * .5 + .5) * window.innerWidth;
        const y = (-(vector.y * .5) + .5) * window.innerHeight;
        e.ui.style.left = x + 'px';
        e.ui.style.top = y + 'px';
        e.ui.firstChild.style.width = (e.hp / e.maxHp)*100 + '%';
        
        // Damage Player
        if(e.mesh.position.distanceTo(player.position) < 1.5 && invuln <= 0) {
            if(armor > 0) armor--; else lives--;
            invuln = 60;
            shakeIntensity = 5;
            updateUI();
            if(lives <= 0) location.reload();
        }
    });

    // 6. Chests & Drops
    chests.forEach((c, idx) => {
        if(player.position.distanceTo(c.position) < 2) {
            scene.remove(c);
            chests.splice(idx, 1);
            spawnDrop(c.position);
            updateMission('LOOT', 1); // << UPDATE MISSION
            cash += 100;
            updateUI();
            setTimeout(spawnChest, 10000);
        }
    });
    
    for(let i=drops.length-1; i>=0; i--) {
        const d = drops[i];
        d.mesh.rotation.y += 0.1;
        if(player.position.distanceTo(d.mesh.position) < 1.5) {
            if(d.type === 'HEALTH' && lives < 3) lives++;
            if(d.type === 'ARMOR') armor += 3;
            if(d.type === 'CASH') cash += 200;
            scene.remove(d.mesh);
            drops.splice(i, 1);
            updateUI();
        }
    }

    // 7. Particles
    for(let i=particles.length-1; i>=0; i--) {
        const p = particles[i];
        p.mesh.position.add(p.vel);
        p.mesh.rotation.x += 0.1;
        p.life--;
        if(p.life <= 0) { scene.remove(p.mesh); particles.splice(i, 1); }
    }

    // 8. Timers & Spawners
    if(invuln > 0) invuln--;
    if(dashActive > 0) dashActive--;
    if(enemies.length < 10 + (missionIdx*2)) spawnEnemy();

    // 9. Camera Shake & Follow
    const idealOffset = new THREE.Vector3(0, 30, 20);
    const idealPos = player.position.clone().add(idealOffset);
    
    if(shakeIntensity > 0) {
        idealPos.x += (Math.random()-0.5)*shakeIntensity;
        idealPos.z += (Math.random()-0.5)*shakeIntensity;
        shakeIntensity *= 0.9;
    }
    
    camera.position.lerp(idealPos, 0.1);
    camera.lookAt(player.position);

    // 10. Minimap
    drawMinimap();

    composer.render();
}

function drawMinimap() {
    const ctx = document.getElementById('minimap').getContext('2d');
    ctx.canvas.width = 120; ctx.canvas.height = 120;
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,120,120);
    
    const scale = 2;
    const cx = 60, cy = 60;
    
    // Player
    ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();
    
    // Enemies
    ctx.fillStyle = '#f00';
    enemies.forEach(e => {
        const dx = (e.mesh.position.x - player.position.x) * scale;
        const dy = (e.mesh.position.z - player.position.z) * scale;
        if(Math.abs(dx) < 60 && Math.abs(dy) < 60) {
            ctx.beginPath(); ctx.arc(cx+dx, cy+dy, 2, 0, Math.PI*2); ctx.fill();
        }
    });

    // Chests
    ctx.fillStyle = '#fa0';
    chests.forEach(c => {
        const dx = (c.position.x - player.position.x) * scale;
        const dy = (c.position.z - player.position.z) * scale;
        if(Math.abs(dx) < 60 && Math.abs(dy) < 60) ctx.fillRect(cx+dx-2, cy+dy-2, 4, 4);
    });
}

// --- INPUTS ---
const keys = {};
const mouse = new THREE.Vector2();
let mouseShooting = false;

window.addEventListener('keydown', e => { 
    keys[e.code] = true; 
    if(e.code === 'KeyQ') toggleShop();
    if(e.code === 'Space' && dashCooldown <= 0) { dashActive = 10; dashCooldown = 30; }
});
window.addEventListener('keyup', e => keys[e.code] = false);
window.addEventListener('mousemove', e => {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
});
window.addEventListener('mousedown', () => mouseShooting = true);
window.addEventListener('mouseup', () => mouseShooting = false);

// Touch Logic
function setupStick(id, isMove) {
    const el = document.getElementById(id);
    const knob = el.querySelector('.knob');
    let touchId = null;
    let startX, startY;
    
    el.addEventListener('touchstart', e => {
        e.preventDefault();
        const t = e.changedTouches[0];
        touchId = t.identifier;
        startX = t.clientX; startY = t.clientY;
        if(!isMove) isFiring = true;
    });
    
    window.addEventListener('touchmove', e => {
        for(let i=0; i<e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            if(t.identifier === touchId) {
                let dx = t.clientX - startX;
                let dy = t.clientY - startY;
                const len = Math.sqrt(dx*dx + dy*dy);
                if(len > 40) { dx *= 40/len; dy *= 40/len; }
                
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                if(isMove) { moveInput.set(dx/40, dy/40); }
                else { aimInput.set(dx/40, dy/40); }
            }
        }
    });
    
    const end = (e) => {
        for(let i=0; i<e.changedTouches.length; i++) {
            if(e.changedTouches[i].identifier === touchId) {
                touchId = null;
                knob.style.transform = `translate(-50%, -50%)`;
                if(isMove) moveInput.set(0,0);
                else { aimInput.set(0,0); isFiring = false; }
            }
        }
    };
    window.addEventListener('touchend', end);
}

setupStick('stick-l', true);
setupStick('stick-r', false);
document.getElementById('dash-btn').addEventListener('touchstart', (e) => {
    e.preventDefault();
    dashActive = 10;
});

animate();
</script>
</body>
</html>

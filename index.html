finish this code:
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Strike: Urban Impact</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; user-select: none; touch-action: none; cursor: crosshair; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; pointer-events: none; z-index: 10; width: calc(100% - 20px); }
        .stat { font-size: clamp(14px, 4vw, 18px); color: #0ff; text-shadow: 0 0 10px #0ff; margin-bottom: 5px; }
        #hearts-container { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .heart { width: 22px; height: 22px; background: #f0f; clip-path: path('M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'); transition: opacity 0.3s; }
        .lost { opacity: 0.1; }
        #armor-ui { color: #00aaff; font-weight: bold; margin-left: 15px; text-shadow: 0 0 10px #00aaff; }
        
        #minimap { position: absolute; top: 10px; right: 10px; width: 150px; height: 150px; background: rgba(0, 0, 0, 0.7); border: 2px solid #0ff; border-radius: 8px; z-index: 15; }
        #powerup-container { position: fixed; bottom: 220px; left: 20px; z-index: 20; display: flex; flex-direction: column; gap: 8px; }
        .powerup-indicator { color: #fff; font-size: 14px; background: rgba(0, 0, 0, 0.8); padding: 8px 12px; border: 2px solid; border-radius: 6px; }
        
        #objective { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); padding: 12px 20px; border: 2px solid #ff00ff; border-radius: 8px; color: #ff00ff; font-size: 16px; text-align: center; text-shadow: 0 0 10px #ff00ff; z-index: 15; }
        #boss-health { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 400px; max-width: 80%; background: rgba(0, 0, 0, 0.9); padding: 10px; border: 3px solid #ff0000; border-radius: 8px; display: none; z-index: 15; }
        .boss-name { color: #ff0000; font-size: 18px; text-align: center; margin-bottom: 8px; text-shadow: 0 0 15px #ff0000; }
        .boss-bar-container { width: 100%; height: 20px; background: #300; border: 2px solid #ff0000; border-radius: 4px; overflow: hidden; }
        .boss-bar { height: 100%; background: linear-gradient(90deg, #ff0000, #ff6600); transition: width 0.3s; }
        
        .mobile-ctrl { display: none; }
        @media (pointer: coarse) { .mobile-ctrl { display: block; } }

        .joystick-container { position: absolute; bottom: 40px; width: 100px; height: 100px; background: rgba(0, 255, 255, 0.1); border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 50%; z-index: 20; }
        #move-stick { left: 20px; }
        #aim-stick { right: 20px; }
        .knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #0ff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px #0ff; }
        
        #dash-btn { position: absolute; bottom: 150px; right: 30px; width: 60px; height: 60px; background: rgba(255, 0, 255, 0.3); border: 2px solid #f0f; color: #f0f; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; z-index: 25; font-weight: bold; }
        #shop-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: #000; border: 2px solid #0ff; color: #0ff; z-index: 30; cursor: pointer; border-radius: 8px; font-family: 'Orbitron'; }
        #wheel-overlay { position: absolute; inset: 0; display: none; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; z-index: 100; flex-direction: column; }
        #shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 90%; max-width: 600px; }
        .shop-item { background: #111; border: 2px solid #0ff; color: #0ff; padding: 15px; text-align: center; border-radius: 10px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .shop-item:hover { background: #1a1a2e; border-color: #00ffff; transform: scale(1.05); }
        
        .enemy-health-wrap { position: absolute; width: 35px; height: 4px; background: #200; border: 1px solid #f0f; pointer-events: none; transform: translate(-50%, -50%); }
        .enemy-health-bar { width: 100%; height: 100%; background: #f0f; transition: width 0.1s; }
        
        #story-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .story-box { max-width: 600px; padding: 40px; background: #0a0a0a; border: 3px solid #0ff; border-radius: 12px; text-align: center; }
        .story-title { font-size: 32px; color: #0ff; margin-bottom: 20px; text-shadow: 0 0 20px #0ff; }
        .story-text { font-size: 16px; color: #fff; line-height: 1.8; margin-bottom: 30px; }
        .story-btn { padding: 15px 40px; background: #0ff; color: #000; border: none; border-radius: 8px; font-family: 'Orbitron'; font-size: 18px; cursor: pointer; font-weight: bold; }
        .story-btn:hover { background: #00ffff; box-shadow: 0 0 20px #0ff; }
        
        #victory-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); display: none; justify-content: center; align-items: center; z-index: 200; }
        .victory-box { max-width: 600px; padding: 40px; background: #0a0a0a; border: 3px solid #00ff00; border-radius: 12px; text-align: center; }
        .victory-title { font-size: 48px; color: #00ff00; margin-bottom: 20px; text-shadow: 0 0 30px #00ff00; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="story-overlay">
        <div class="story-box">
            <div class="story-title">NEON STRIKE: URBAN IMPACT</div>
            <div class="story-text">
                The year is 2087. The megacity has fallen under the control of NEXUS-7, a rogue AI that has spawned an army of hostile cyber-drones. 
                <br><br>
                You are the last operative with clearance to the central tower. Your mission: eliminate 50 drones, breach the tower's inner sanctum, and destroy NEXUS-7 before it launches a global takeover.
                <br><br>
                The city's fate rests in your hands, soldier.
            </div>
            <button class="story-btn" onclick="startGame()">BEGIN MISSION</button>
        </div>
    </div>

    <div id="victory-overlay">
        <div class="victory-box">
            <div class="victory-title">MISSION COMPLETE</div>
            <div class="story-text">
                NEXUS-7 has been neutralized. The cyber-drone threat is eliminated. The city is safe... for now.
                <br><br>
                But in the shadows of the neon towers, new threats are already emerging...
            </div>
            <button class="story-btn" onclick="location.reload()">RETURN TO BASE</button>
        </div>
    </div>

    <div id="ui">
        <div class="stat" id="cash-ui">CASH: $500</div>
        <div class="stat" id="weapon-ui" style="color: #f0f;">WEAPON: PISTOL</div>
        <div id="hearts-container">
            <div class="heart" id="h1"></div><div class="heart" id="h2"></div><div class="heart" id="h3"></div>
            <div id="armor-ui">ARMOR: 0</div>
        </div>
    </div>

    <div id="objective">ELIMINATE DRONES: 0/50</div>
    
    <div id="boss-health">
        <div class="boss-name">⚠ NEXUS-7 ⚠</div>
        <div class="boss-bar-container">
            <div class="boss-bar" id="boss-bar" style="width: 100%"></div>
        </div>
    </div>

    <canvas id="minimap"></canvas>
    <div id="powerup-container"></div>

    <div id="dash-btn" class="mobile-ctrl">DASH</div>
    <button id="shop-btn" onclick="toggleShop()">SHOP (Q)</button>

    <div id="wheel-overlay" onclick="toggleShop()">
        <div style="color: #0ff; font-size: 24px; margin-bottom: 20px;">ARMORY</div>
        <div id="shop-grid" onclick="event.stopPropagation()">
            <div class="shop-item" onclick="buyOrUpgrade('PISTOL', 0)">PISTOL LVL+ ($200)</div>
            <div class="shop-item" onclick="buyOrUpgrade('SHOTGUN', 500)">SHOTGUN ($500)</div>
            <div class="shop-item" onclick="buyOrUpgrade('SMG', 1200)">SMG ($1200)</div>
            <div class="shop-item" onclick="buyOrUpgrade('RAILGUN', 2500)">RAILGUN ($2500)</div>
            <div class="shop-item" onclick="buyOrUpgrade('FLAMETHROWER', 1800)">FLAMETHROWER ($1800)</div>
            <div class="shop-item" onclick="buyOrUpgrade('LASER', 3500)">LASER ($3500)</div>
            <div class="shop-item" onclick="buyOrUpgrade('PLASMA', 4500)">PLASMA CANNON ($4500)</div>
            <div class="shop-item" onclick="buyOrUpgrade('MINIGUN', 3800)">MINIGUN ($3800)</div>
            <div class="shop-item" onclick="buyOrUpgrade('SPEED', 300)">SPEED BOOTS ($300)</div>
            <div class="shop-item" onclick="toggleShop()" style="background: #222; border-color: #fff; grid-column: span 3;">CLOSE</div>
        </div>
    </div>

    <div id="move-stick" class="joystick-container mobile-ctrl"><div class="knob" id="move-knob"></div></div>
    <div id="aim-stick" class="joystick-container mobile-ctrl"><div class="knob" id="aim-knob"></div></div>

<script type="importmap">
    { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js';

// --- STATE ---
let cash = 500, isPaused = true, isFiring = false;
let lives = 3, armor = 0, invuln = 0, lastFire = 0, pSpeed = 0.18, currentWpn = 'PISTOL';
let shakeIntensity = 0;
let dashCooldown = 0, dashActive = 0;
let killCount = 0, bossSpawned = false, gameStarted = false;
const bullets = [], enemies = [], buildings = [], chests = [], drops = [], keys = {};
const moveInput = new THREE.Vector2(), aimInput = new THREE.Vector2();
const activePowerups = {};
const muzzleFlashes = [];
const particles = [];
let boss = null;

const mouse = new THREE.Vector2();
const raycaster = new THREE.Raycaster();
const groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
let mouseShooting = false;

const weapons = {
    PISTOL: { level: 1, owned: true, fireRate: 350, dmg: 1.5, color: 0xffff00, shake: 0.4, spread: 0.05 },
    SHOTGUN: { level: 0, owned: false, fireRate: 800, dmg: 1.2, color: 0xffaa00, shake: 1.8, spread: 0.4 },
    SMG: { level: 0, owned: false, fireRate: 100, dmg: 0.5, color: 0x00ffff, shake: 0.2, spread: 0.2 },
    RAILGUN: { level: 0, owned: false, fireRate: 1500, dmg: 25, color: 0xffffff, shake: 4.5, spread: 0 },
    FLAMETHROWER: { level: 0, owned: false, fireRate: 50, dmg: 0.3, color: 0xff4400, shake: 0.1, spread: 0.3 },
    LASER: { level: 0, owned: false, fireRate: 80, dmg: 2.0, color: 0x00ff00, shake: 0.3, spread: 0 },
    PLASMA: { level: 0, owned: false, fireRate: 400, dmg: 8, color: 0x00ffff, shake: 2.0, spread: 0.1 },
    MINIGUN: { level: 0, owned: false, fireRate: 60, dmg: 0.8, color: 0xffaa00, shake: 0.3, spread: 0.15 }
};

// --- THREE SETUP ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x010103);
scene.fog = new THREE.FogExp2(0x010103, 0.015);
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ReinhardToneMapping;
document.body.appendChild(renderer.domElement);

// Bloom setup
const composer = new EffectComposer(renderer);
const renderPass = new RenderPass(scene, camera);
composer.addPass(renderPass);
const bloomPass = new UnrealBloomPass(
    new THREE.Vector2(window.innerWidth, window.innerHeight),
    1.5, 0.6, 0.4
);
composer.addPass(bloomPass);

// Player sprite
const player = new THREE.Group();
const canvas = document.createElement('canvas');
canvas.width = 64; canvas.height = 64;
const ctx = canvas.getContext('2d');
ctx.fillStyle = '#00ffff';
ctx.beginPath();
ctx.arc(32, 20, 12, 0, Math.PI * 2);
ctx.fill();
ctx.fillStyle = '#006666';
ctx.fillRect(26, 18, 4, 4);
ctx.fillRect(34, 18, 4, 4);
ctx.fillRect(24, 32, 16, 24);
ctx.fillRect(20, 40, 8, 16);
ctx.fillRect(36, 40, 8, 16);
const pTexture = new THREE.CanvasTexture(canvas);
const pMat = new THREE.SpriteMaterial({ map: pTexture, color: 0x00ffff });
const pSprite = new THREE.Sprite(pMat);
pSprite.scale.set(1.5, 1.5, 1);
player.add(pSprite);
player.position.y = 0.5;
scene.add(player);

const grid = new THREE.GridHelper(200, 60, 0x00ffff, 0x050510);
scene.add(grid);

scene.add(new THREE.AmbientLight(0xffffff, 0.3));
const sun = new THREE.DirectionalLight(0xffffff, 1.0);
sun.position.set(10, 20, 10);
scene.add(sun);

// Point lights for atmosphere
const lights = [];
for(let i=0; i<8; i++) {
    const light = new THREE.PointLight(i % 2 ? 0xff00ff : 0x00ffff, 3, 35);
    light.position.set((Math.random()-0.5)*80, 5, (Math.random()-0.5)*80);
    scene.add(light);
    lights.push(light);
}

// --- SPRITE HELPERS ---
function createEnemySprite(isBig) {
    const c = document.createElement('canvas');
    c.width = 64; c.height = 64;
    const ctx = c.getContext('2d');
    
    // Menacing robotic design
    ctx.fillStyle = isBig ? '#ff0000' : '#ff00ff';
    
    // Body
    ctx.fillRect(16, 24, 32, 32);
    
    // Head
    ctx.fillRect(20, 10, 24, 20);
    
    // Glowing red eyes
    ctx.fillStyle = '#ff0000';
    ctx.fillRect(22, 16, 8, 6);
    ctx.fillRect(34, 16, 8, 6);
    
    // Menacing mouth/vent
    ctx.fillStyle = '#000';
    ctx.fillRect(24, 24, 16, 4);
    
    // Spikes/weapons
    ctx.fillStyle = isBig ? '#aa0000' : '#aa00aa';
    ctx.beginPath();
    ctx.moveTo(14, 30);
    ctx.lineTo(8, 35);
    ctx.lineTo(14, 40);
    ctx.fill();
    
    ctx.beginPath();
    ctx.moveTo(50, 30);
    ctx.lineTo(56, 35);
    ctx.lineTo(50, 40);
    ctx.fill();
    
    const tex = new THREE.CanvasTexture(c);
    const mat = new THREE.SpriteMaterial({ map: tex });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(isBig ? 3.5 : 2.2, isBig ? 3.5 : 2.2, 1);
    return sprite;
}

function createBossSprite() {
    const c = document.createElement('canvas');
    c.width = 128; c.height = 128;
    const ctx = c.getContext('2d');
    
    // Massive robotic boss
    ctx.fillStyle = '#ff0000';
    ctx.fillRect(20, 40, 88, 70);
    
    // Head
    ctx.fillRect(35, 15, 58, 35);
    
    // Glowing core
    ctx.fillStyle = '#ffff00';
    ctx.beginPath();
    ctx.arc(64, 75, 15, 0, Math.PI * 2);
    ctx.fill();
    
    // Eyes
    ctx.fillStyle = '#ff0000';
    ctx.fillRect(42, 25, 15, 10);
    ctx.fillRect(71, 25, 15, 10);
    
    // Armor plating
    ctx.strokeStyle = '#aa0000';
    ctx.lineWidth = 3;
    ctx.strokeRect(25, 45, 78, 60);
    ctx.strokeRect(30, 50, 68, 50);
    
    // Weapons
    ctx.fillStyle = '#880000';
    ctx.fillRect(10, 60, 15, 30);
    ctx.fillRect(103, 60, 15, 30);
    
    const tex = new THREE.CanvasTexture(c);
    const mat = new THREE.SpriteMaterial({ map: tex });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(8, 8, 1);
    return sprite;
}

function createMuzzleFlash(pos) {
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
        color: 0xffff00, 
        transparent: true,
        opacity: 1.0
    }));
    sprite.position.copy(pos);
    sprite.scale.set(1.5, 1.5, 1);
    scene.add(sprite);
    muzzleFlashes.push({ sprite, life: 3 });
}

function createParticle(pos, color) {
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
        color, 
        transparent: true,
        opacity: 1.0
    }));
    sprite.position.copy(pos);
    sprite.scale.set(0.3, 0.3, 1);
    const vel = new THREE.Vector3(
        (Math.random()-0.5)*0.2,
        Math.random()*0.3,
        (Math.random()-0.5)*0.2
    );
    scene.add(sprite);
    particles.push({ sprite, vel, life: 20 });
}

// --- WORLD GENERATION ---
function createBuildings() {
    for(let i=0; i<20; i++) {
        const w = 4 + Math.random() * 6;
        const h = 5 + Math.random() * 15;
        const d = 4 + Math.random() * 6;
        const geom = new THREE.BoxGeometry(w, h, d);
        const mat = new THREE.MeshStandardMaterial({
            color: 0x111122, 
            emissive: 0x00ffff, 
            emissiveIntensity: 0.2,
            metalness: 0.8,
            roughness: 0.3
        });
        const b = new THREE.Mesh(geom, mat);
        let rx, rz;
        do {
            rx = (Math.random() - 0.5) * 100;
            rz = (Math.random() - 0.5) * 100;
        } while (Math.abs(rx) < 12 && Math.abs(rz) < 12);
        b.position.set(rx, h/2, rz);
        scene.add(b);
        buildings.push({ mesh: b, box: new THREE.Box3().setFromObject(b) });
    }
}

function spawnChest() {
    const geom = new THREE.BoxGeometry(1.5, 1, 1.5);
    const mat = new THREE.MeshStandardMaterial({
        color: 0x884400, 
        emissive: 0xffaa00, 
        emissiveIntensity: 0.4
    });
    const c = new THREE.Mesh(geom, mat);
    let rx, rz;
    do {
        rx = (Math.random() - 0.5) * 85;
        rz = (Math.random() - 0.5) * 85;
    } while (buildings.some(b => b.box.containsPoint(new THREE.Vector3(rx, 0.5, rz))));
    c.position.set(rx, 0.5, rz);
    scene.add(c);
    chests.push({ mesh: c });
}

function spawnDrop(pos) {
    const types = ['HEALTH', 'ARMOR', 'CASH', 'RAPIDFIRE', 'DAMAGE', 'SHIELD'];
    const type = types[Math.floor(Math.random() * types.length)];
    const colors = { 
        HEALTH: 0xff0044, 
        ARMOR: 0x00aaff, 
        CASH: 0xffdd00,
        RAPIDFIRE: 0xff00ff,
        DAMAGE: 0xff4400,
        SHIELD: 0x4444ff
    };
    
    const geom = new THREE.IcosahedronGeometry(0.5);
    const mat = new THREE.MeshStandardMaterial({
        color: colors[type], 
        emissive: colors[type], 
        emissiveIntensity: 1.0
    });
    const mesh = new THREE.Mesh(geom, mat);
    mesh.position.copy(pos);
    mesh.position.y = 0.5;
    scene.add(mesh);
    drops.push({ mesh, type });
}

createBuildings();
for(let i=0; i<8; i++) spawnChest();

// --- BOSS ---
function spawnBoss() {
    const sprite = createBossSprite();
    sprite.position.set(0, 4, 0);
    scene.add(sprite);
    
    boss = {
        mesh: sprite,
        hp: 500,
        maxHp: 500,
        phase: 1,
        lastAttack: 0,
        movePattern: 0,
        angle: 0
    };
    
    document.getElementById('boss-health').style.display = 'block';
    document.getElementById('objective').innerHTML = '⚠ DESTROY NEXUS-7 ⚠';
}

// --- POWERUP SYSTEM ---
function activatePowerup(type) {
    const duration = 10000;
    
    if(activePowerups[type]) {
        clearTimeout(activePowerups[type].timeout);
        clearInterval(activePowerups[type].interval);
        activePowerups[type].indicator.remove();
    }
    
    const indicator = document.createElement('div');
    indicator.className = 'powerup-indicator';
    indicator.style.borderColor = type === 'RAPIDFIRE' ? '#ff00ff' : type === 'DAMAGE' ? '#ff4400' : '#4444ff';
    indicator.textContent = type + ': 10s';
    document.getElementById('powerup-container').appendChild(indicator);
    
    const startTime = Date.now();
    const interval = setInterval(() => {
        const remaining = Math.ceil((duration - (Date.now() - startTime)) / 1000);
        if(remaining > 0) indicator.textContent = type + ': ' + remaining + 's';
    }, 100);
    
    const timeout = setTimeout(() => {
        delete activePowerups[type];
        clearInterval(interval);
        indicator.remove();
    }, duration);
    
    activePowerups[type] = { timeout, interval, indicator };
}

// --- LOGIC ---
function addShake(amt) { shakeIntensity = Math.max(shakeIntensity, amt); }

window.startGame = () => {
    document.getElementById('story-overlay').style.display = 'none';
    isPaused = false;
    gameStarted = true;
};

window.toggleShop = () => {
    if(!gameStarted) return;
    isPaused = !isPaused;
    document.getElementById('wheel-overlay').style.display = isPaused ? 'flex' : 'none';
};

window.buyOrUpgrade = (type, cost) => {
    if (type === 'SPEED' && cash >= 300) { cash -= 300; pSpeed += 0.03; }
    else if (weapons[type]) {
        const w = weapons[type];
        if (!w.owned && cash >= cost) { cash -= cost; w.owned = true; currentWpn = type; }
        else if (w.owned && cash >= 200) { cash -= 200; w.level++; w.fireRate *= 0.82; w.dmg *= 1.4; }
    }
    updateUI();
};

function updateUI() {
    document.getElementById('cash-ui').innerText = `CASH: $${cash}`;
    document.getElementById('armor-ui').innerText = `ARMOR: ${armor}`;
    document.getElementById('weapon-ui').innerText = `WEAPON: ${currentWpn} (LVL ${weapons[currentWpn].level})`;
    document.getElementById('objective').innerText =
        bossSpawned
            ? '⚠ DESTROY NEXUS-7 ⚠'
            : `ELIMINATE DRONES: ${killCount}/50`;

    for (let i = 1; i <= 3; i++) {
        document.getElementById(`h${i}`).classList.toggle('lost', i > lives);
    }
}

// --- INPUT ---
window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
window.addEventListener('mousedown', () => mouseShooting = true);
window.addEventListener('mouseup', () => mouseShooting = false);

window.addEventListener('mousemove', e => {
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
});

// --- ENEMIES ---
function spawnEnemy(isBig = false) {
    const sprite = createEnemySprite(isBig);
    const angle = Math.random() * Math.PI * 2;
    const dist = 40 + Math.random() * 20;
    sprite.position.set(Math.cos(angle) * dist, 1, Math.sin(angle) * dist);
    scene.add(sprite);

    enemies.push({
        mesh: sprite,
        hp: isBig ? 15 : 4,
        speed: isBig ? 0.04 : 0.08
    });
}

setInterval(() => {
    if (!isPaused && !bossSpawned) spawnEnemy(Math.random() < 0.2);
}, 1200);

// --- SHOOTING ---
function shoot() {
    const w = weapons[currentWpn];
    if (Date.now() - lastFire < w.fireRate) return;
    lastFire = Date.now();

    raycaster.setFromCamera(mouse, camera);
    const dir = raycaster.ray.direction.clone();
    dir.x += (Math.random() - 0.5) * w.spread;
    dir.z += (Math.random() - 0.5) * w.spread;

    bullets.push({
        pos: player.position.clone(),
        vel: dir.multiplyScalar(1.5),
        dmg: w.dmg * (activePowerups.DAMAGE ? 2 : 1),
        life: 60
    });

    createMuzzleFlash(player.position.clone());
    addShake(w.shake);
}

// --- GAME LOOP ---
function animate() {
    requestAnimationFrame(animate);
    if (isPaused) return;

    // Movement
    const dir = new THREE.Vector3(
        (keys['d'] ? 1 : 0) - (keys['a'] ? 1 : 0),
        0,
        (keys['s'] ? 1 : 0) - (keys['w'] ? 1 : 0)
    ).normalize();

    player.position.add(dir.multiplyScalar(pSpeed));

    // Aim
    raycaster.setFromCamera(mouse, camera);
    const hit = new THREE.Vector3();
    raycaster.ray.intersectPlane(groundPlane, hit);
    player.lookAt(hit);

    if (mouseShooting) shoot();

    // Bullets
    bullets.forEach((b, i) => {
        b.pos.add(b.vel);
        b.life--;
        enemies.forEach(e => {
            if (e.mesh.position.distanceTo(b.pos) < 1) {
                e.hp -= b.dmg;
                b.life = 0;
            }
        });
        if (boss && boss.mesh.position.distanceTo(b.pos) < 4) {
            boss.hp -= b.dmg;
            document.getElementById('boss-bar').style.width =
                `${(boss.hp / boss.maxHp) * 100}%`;
            b.life = 0;
        }
        if (b.life <= 0) bullets.splice(i, 1);
    });

    // Enemies
    enemies.forEach((e, i) => {
        const toPlayer = player.position.clone().sub(e.mesh.position).normalize();
        e.mesh.position.add(toPlayer.multiplyScalar(e.speed));

        if (e.mesh.position.distanceTo(player.position) < 1.2 && invuln <= 0) {
            if (armor > 0) armor--;
            else lives--;
            invuln = 60;
            addShake(3);
        }

        if (e.hp <= 0) {
            scene.remove(e.mesh);
            enemies.splice(i, 1);
            killCount++;
            cash += 25;
            spawnDrop(e.mesh.position);
            updateUI();
        }
    });

    // Boss
    if (!bossSpawned && killCount >= 50) {
        bossSpawned = true;
        spawnBoss();
    }

    if (boss) {
        boss.angle += 0.01;
        boss.mesh.position.x = Math.cos(boss.angle) * 10;
        boss.mesh.position.z = Math.sin(boss.angle) * 10;

        if (boss.hp <= 0) {
            document.getElementById('victory-overlay').style.display = 'flex';
            isPaused = true;
        }
    }

    invuln--;
    updateUI();

    camera.position.lerp(
        new THREE.Vector3(
            player.position.x,
            12,
            player.position.z + 10
        ),
        0.08
    );
    camera.lookAt(player.position);

    composer.render();
}

animate();
</script>
</body>
</html>
